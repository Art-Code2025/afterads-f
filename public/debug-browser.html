<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุดุฎูุต ุงููุดููุฉ - ุงูููุถูุฉ ูุงูุณูุฉ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .data {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ุชุดุฎูุต ูุดุงูู ุงูููุถูุฉ ูุงูุณูุฉ</h1>
        
        <div class="section">
            <h3>ุจูุงูุงุช localStorage ุงูุญุงููุฉ</h3>
            <button onclick="checkLocalStorage()">ูุญุต localStorage</button>
            <div id="localStorage-data" class="data"></div>
        </div>
        
        <div class="section">
            <h3>ุจูุงูุงุช ุงููุณุชุฎุฏู</h3>
            <button onclick="checkUserData()">ูุญุต ุจูุงูุงุช ุงููุณุชุฎุฏู</button>
            <div id="user-data" class="data"></div>
        </div>
        
        <div class="section">
            <h3>ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ููุชุฌ ููููุถูุฉ</h3>
            <button onclick="testAddToWishlist()">ุฅุถุงูุฉ ููุชุฌ ุชุฌุฑูุจู ููููุถูุฉ</button>
            <button onclick="testRemoveFromWishlist()">ุฅุฒุงูุฉ ููุชุฌ ูู ุงูููุถูุฉ</button>
        </div>
        
        <div class="section">
            <h3>ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ููุชุฌ ููุณูุฉ</h3>
            <button onclick="testAddToCart()">ุฅุถุงูุฉ ููุชุฌ ุชุฌุฑูุจู ููุณูุฉ</button>
            <button onclick="testRemoveFromCart()">ุฅุฒุงูุฉ ููุชุฌ ูู ุงูุณูุฉ</button>
        </div>
        
        <div class="section">
            <h3>ูุฑุงูุจุฉ ุงูุฃุญุฏุงุซ</h3>
            <button onclick="startEventMonitoring()">ุจุฏุก ูุฑุงูุจุฉ ุงูุฃุญุฏุงุซ</button>
            <button onclick="stopEventMonitoring()">ุฅููุงู ูุฑุงูุจุฉ ุงูุฃุญุฏุงุซ</button>
            <button onclick="clearLogs()">ูุณุญ ุงูุณุฌูุงุช</button>
            <div id="event-logs" class="log"></div>
        </div>
        
        <div class="section">
            <h3>ุฅุนุงุฏุฉ ุชุญููู ุงูุนุฏุงุฏุงุช</h3>
            <button onclick="triggerCounterUpdate()">ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช</button>
            <button onclick="clearAllData()">ูุณุญ ุฌููุน ุงูุจูุงูุงุช</button>
        </div>
    </div>

    <script>
        let eventMonitoring = false;
        let eventListeners = [];
        
        function log(message) {
            const logs = document.getElementById('event-logs');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function checkLocalStorage() {
            const data = {
                cart: localStorage.getItem('cart'),
                wishlist: localStorage.getItem('wishlist'),
                user: localStorage.getItem('user'),
                lastCartCount: localStorage.getItem('lastCartCount'),
                lastWishlistCount: localStorage.getItem('lastWishlistCount'),
                cartUpdated: localStorage.getItem('cartUpdated'),
                wishlistUpdated: localStorage.getItem('wishlistUpdated')
            };
            
            let output = '';
            for (const [key, value] of Object.entries(data)) {
                output += `${key}: ${value || 'null'}\n`;
                if (value && (key === 'cart' || key === 'wishlist' || key === 'user')) {
                    try {
                        const parsed = JSON.parse(value);
                        output += `  โโ parsed: ${JSON.stringify(parsed, null, 2)}\n`;
                    } catch (e) {
                        output += `  โโ parse error: ${e.message}\n`;
                    }
                }
                output += '\n';
            }
            
            document.getElementById('localStorage-data').textContent = output;
        }
        
        function checkUserData() {
            const userData = localStorage.getItem('user');
            let output = 'ุจูุงูุงุช ุงููุณุชุฎุฏู: ';
            
            if (!userData) {
                output += 'ุบูุฑ ููุฌูุฏ (ูุณุชุฎุฏู ุถูู)';
            } else {
                try {
                    const user = JSON.parse(userData);
                    output += JSON.stringify(user, null, 2);
                } catch (e) {
                    output += `ุฎุทุฃ ูู ุงูุชุญููู: ${e.message}`;
                }
            }
            
            document.getElementById('user-data').textContent = output;
        }
        
        function testAddToWishlist() {
            const testProduct = {
                id: 999,
                name: 'ููุชุฌ ุชุฌุฑูุจู',
                price: 100,
                mainImage: '/test-image.jpg'
            };
            
            // ูุญุงูุงุฉ ุฅุถุงูุฉ ููููุถูุฉ
            let wishlist = [];
            const savedWishlist = localStorage.getItem('wishlist');
            if (savedWishlist) {
                try {
                    wishlist = JSON.parse(savedWishlist);
                } catch (e) {
                    wishlist = [];
                }
            }
            
            // ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุงูููุชุฌ ูุณุจูุงู
            const exists = wishlist.find(item => item.id === testProduct.id);
            if (!exists) {
                wishlist.push(testProduct);
                localStorage.setItem('wishlist', JSON.stringify(wishlist));
                
                // ุฅุฑุณุงู ุญุฏุซ ุงูุชุญุฏูุซ
                window.dispatchEvent(new CustomEvent('wishlistUpdated', {
                    detail: { currentWishlist: wishlist }
                }));
                
                log(`ุชู ุฅุถุงูุฉ ููุชุฌ ุชุฌุฑูุจู ููููุถูุฉ. ุงูุนุฏุฏ ุงูุญุงูู: ${wishlist.length}`);
            } else {
                log('ุงูููุชุฌ ุงูุชุฌุฑูุจู ููุฌูุฏ ุจุงููุนู ูู ุงูููุถูุฉ');
            }
            
            checkLocalStorage();
        }
        
        function testRemoveFromWishlist() {
            let wishlist = [];
            const savedWishlist = localStorage.getItem('wishlist');
            if (savedWishlist) {
                try {
                    wishlist = JSON.parse(savedWishlist);
                } catch (e) {
                    wishlist = [];
                }
            }
            
            const originalLength = wishlist.length;
            wishlist = wishlist.filter(item => item.id !== 999);
            
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            
            // ุฅุฑุณุงู ุญุฏุซ ุงูุชุญุฏูุซ
            window.dispatchEvent(new CustomEvent('wishlistUpdated', {
                detail: { currentWishlist: wishlist }
            }));
            
            log(`ุชู ุฅุฒุงูุฉ ุงูููุชุฌ ุงูุชุฌุฑูุจู. ุงูุนุฏุฏ ูุจู: ${originalLength}, ุจุนุฏ: ${wishlist.length}`);
            checkLocalStorage();
        }
        
        function testAddToCart() {
            const testCartItem = {
                id: Date.now(),
                productId: 999,
                quantity: 1,
                product: {
                    id: 999,
                    name: 'ููุชุฌ ุชุฌุฑูุจู ููุณูุฉ',
                    price: 150,
                    mainImage: '/test-cart-image.jpg'
                }
            };
            
            let cart = [];
            const savedCart = localStorage.getItem('cart');
            if (savedCart) {
                try {
                    cart = JSON.parse(savedCart);
                } catch (e) {
                    cart = [];
                }
            }
            
            cart.push(testCartItem);
            localStorage.setItem('cart', JSON.stringify(cart));
            
            // ุฅุฑุณุงู ุญุฏุซ ุงูุชุญุฏูุซ
            window.dispatchEvent(new CustomEvent('cartUpdated'));
            window.dispatchEvent(new CustomEvent('productAddedToCart', {
                detail: { product: testCartItem.product }
            }));
            
            log(`ุชู ุฅุถุงูุฉ ููุชุฌ ุชุฌุฑูุจู ููุณูุฉ. ุงูุนุฏุฏ ุงูุญุงูู: ${cart.length}`);
            checkLocalStorage();
        }
        
        function testRemoveFromCart() {
            let cart = [];
            const savedCart = localStorage.getItem('cart');
            if (savedCart) {
                try {
                    cart = JSON.parse(savedCart);
                } catch (e) {
                    cart = [];
                }
            }
            
            const originalLength = cart.length;
            cart = cart.filter(item => item.productId !== 999);
            
            localStorage.setItem('cart', JSON.stringify(cart));
            
            // ุฅุฑุณุงู ุญุฏุซ ุงูุชุญุฏูุซ
            window.dispatchEvent(new CustomEvent('cartUpdated'));
            
            log(`ุชู ุฅุฒุงูุฉ ุงูููุชุฌ ุงูุชุฌุฑูุจู ูู ุงูุณูุฉ. ุงูุนุฏุฏ ูุจู: ${originalLength}, ุจุนุฏ: ${cart.length}`);
            checkLocalStorage();
        }
        
        function startEventMonitoring() {
            if (eventMonitoring) return;
            
            eventMonitoring = true;
            const events = [
                'cartUpdated',
                'productAddedToCart',
                'cartCountChanged',
                'forceCartUpdate',
                'wishlistUpdated',
                'productAddedToWishlist',
                'productRemovedFromWishlist'
            ];
            
            events.forEach(eventName => {
                const listener = (e) => {
                    log(`๐ ุญุฏุซ: ${eventName}`);
                    if (e.detail) {
                        log(`   ุงูุชูุงุตูู: ${JSON.stringify(e.detail)}`);
                    }
                };
                
                window.addEventListener(eventName, listener);
                eventListeners.push({ name: eventName, listener });
            });
            
            // ูุฑุงูุจุฉ ุชุบููุฑุงุช localStorage
            const storageListener = (e) => {
                log(`๐พ ุชุบููุฑ localStorage: ${e.key} = ${e.newValue}`);
            };
            
            window.addEventListener('storage', storageListener);
            eventListeners.push({ name: 'storage', listener: storageListener });
            
            log('๐ฏ ุจุฏุฃุช ูุฑุงูุจุฉ ุงูุฃุญุฏุงุซ');
        }
        
        function stopEventMonitoring() {
            eventMonitoring = false;
            
            eventListeners.forEach(({ name, listener }) => {
                window.removeEventListener(name, listener);
            });
            
            eventListeners = [];
            log('โน๏ธ ุชูููุช ูุฑุงูุจุฉ ุงูุฃุญุฏุงุซ');
        }
        
        function clearLogs() {
            document.getElementById('event-logs').innerHTML = '';
        }
        
        function triggerCounterUpdate() {
            // ุฅุฑุณุงู ุฃุญุฏุงุซ ูุชุญุฏูุซ ุงูุนุฏุงุฏุงุช
            window.dispatchEvent(new CustomEvent('cartUpdated'));
            window.dispatchEvent(new CustomEvent('wishlistUpdated'));
            window.dispatchEvent(new CustomEvent('forceCartUpdate'));
            
            log('๐ ุชู ุฅุฑุณุงู ุฃุญุฏุงุซ ุชุญุฏูุซ ุงูุนุฏุงุฏุงุช');
        }
        
        function clearAllData() {
            const keys = ['cart', 'wishlist', 'lastCartCount', 'lastWishlistCount', 'cartUpdated', 'wishlistUpdated'];
            keys.forEach(key => localStorage.removeItem(key));
            
            log('๐๏ธ ุชู ูุณุญ ุฌููุน ุงูุจูุงูุงุช');
            checkLocalStorage();
            triggerCounterUpdate();
        }
        
        // ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ูุชุญ ุงูุตูุญุฉ
        window.onload = function() {
            checkLocalStorage();
            checkUserData();
            log('๐ฑ ุชู ุชุญููู ุตูุญุฉ ุงูุชุดุฎูุต');
        };
    </script>
</body>
</html>